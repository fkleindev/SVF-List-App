<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Trainingsgruppen-Verwaltung</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --accent: #eee061;
            --accent-hover: #d5c74f;
            --bg: #fefefe;
            --text: #333;
            --border: #ddd;
        }

        body {
            font-family: "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
        }

        header {
            background: var(--accent);
            color: #222;
            text-align: center;
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        header img {
            height: 80px;
        }

        header .header-text {
            font-weight: bold;
            font-size: 20px;
        }

        main {
            padding: 30px;
            max-width: 1800px;
            margin: auto;
        }

        #controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
            align-items: center;
        }

        input[type="text"] {
            flex: 1;
            min-width: 220px;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: box-shadow 0.2s;
        }

        input[type="text"]:focus {
            outline: none;
            box-shadow: 0 0 4px var(--accent);
        }

        input[type="file"] {
            display: none;
        }

        label.button,
        button {
            background-color: var(--accent);
            color: #222;
            font-weight: 600;
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }

        label.button:hover,
        button:hover {
            background-color: var(--accent-hover);
            transform: translateY(-1px);
        }

        .material-icons {
            font-size: 18px;
            vertical-align: middle;
        }

        table.dataTable {
            width: 100% !important;
            border-radius: 10px;
            overflow: hidden;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        table.dataTable thead th {
            background-color: var(--accent);
            color: #222;
            font-weight: 600;
        }

        table.dataTable tbody td {
            cursor: default;
        }

        table.dataTable tbody td.editable:hover {
            background-color: #fff9c4;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #fff;
            padding: 25px 30px;
            border-radius: 10px;
            width: 600px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.25);
        }

        .modal-content h2 {
            text-align: center;
            margin-top: 0;
            color: #555;
        }

        .modal-content input {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .modal-buttons {
            margin-top: 20px;
            text-align: right;
        }

        .modal-buttons button {
            margin-left: 10px;
        }

        .edit,
        .delete {
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1.3rem;
            color: #555;
            transition: transform 0.2s;
        }

        .edit:hover {
            color: #fbc02d;
            transform: scale(1.2);
        }

        .delete:hover {
            color: crimson;
            transform: scale(1.2);
        }

        #weekdaySelect label{
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>

<body>
    <header>
        <img src="images/svf_logo.png" alt="Logo" />
        <span class="header-text">Trainingsgruppen-Verwaltung</span>
    </header>

    <main>
        <div id="controls">
            <input type="text" id="groupTitle" placeholder="Titel der Trainingsgruppe" />
            <button id="addRow"><span class="material-icons">person_add</span>Teilnehmer hinzuf√ºgen</button>
            <button id="downloadJSON"><span class="material-icons">download</span>JSON exportieren</button>
            <label class="button" for="uploadJSON"><span class="material-icons">upload</span>JSON importieren</label>
            <input type="file" id="uploadJSON" accept=".json" />
        </div>

        <table id="participants" class="display">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nachname</th>
                    <th>Vorname</th>
                    <th>Jahrgang</th>
                    <th>Telefon</th>
                    <th>Aktionen</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </main>

    <!-- Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Teilnehmer bearbeiten</h2>
            <form id="participantForm">
                <input type="hidden" id="participantId" />
                <label for="nachname">Nachname:</label>
                <input type="text" id="nachname" required />
                <label for="vorname">Vorname:</label>
                <input type="text" id="vorname" required />
                <label for="jahrgang">Jahrgang (TT.MM.JJJJ):</label>
                <input type="text" id="jahrgang" required />
                <label for="telefon">Telefon:</label>
                <input type="text" id="telefon" required />
                <div class="modal-buttons">
                    <button type="button" id="cancelEdit"><span class="material-icons">close</span>Abbrechen</button>
                    <button type="submit" id="saveParticipant"><span
                            class="material-icons">save</span>Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            let table = $("#participants").DataTable({
                columnDefs: [
                    {
                        targets: -1,
                        data: null,
                        defaultContent:
                            '<button class="edit" title="Bearbeiten"><span class="material-icons">edit</span></button>' +
                            '<button class="delete" title="L√∂schen"><span class="material-icons">delete</span></button>'
                    }
                ]
            });

            let idCounter = 1;
            let editRow = null;

            // ========= Bestehende Modal-Logik (gek√ºrzt) =========
            function openModal(title, data) {
                $("#modalTitle").text(title);
                $("#participantId").val(data?.id || "");
                $("#nachname").val(data?.Nachname || "");
                $("#vorname").val(data?.Vorname || "");
                $("#jahrgang").val(data?.Jahrgang || "");
                $("#telefon").val(data?.Telefon || "");
                $("#editModal").fadeIn(150).css("display", "flex");
            }

            function closeModal() {
                $("#editModal").fadeOut(150);
                $("#participantForm")[0].reset();
                editRow = null;
            }

            $("#addRow").on("click", function () {
                editRow = null;
                openModal("Neuen Teilnehmer hinzuf√ºgen", {});
            });

            $("#participants tbody").on("click", "button.edit", function () {
                editRow = table.row($(this).parents("tr"));
                let d = editRow.data();
                openModal("Teilnehmer bearbeiten", {
                    id: d[0],
                    Nachname: d[1],
                    Vorname: d[2],
                    Jahrgang: d[3],
                    Telefon: d[4],
                });
            });

            $("#participants tbody").on("click", "button.delete", function () {
                if (confirm("Teilnehmer wirklich l√∂schen?")) {
                    table.row($(this).parents("tr")).remove().draw();
                }
            });

            $("#participantForm").on("submit", function (e) {
                e.preventDefault();
                let id = $("#participantId").val();
                let nachname = $("#nachname").val().trim();
                let vorname = $("#vorname").val().trim();
                let jahrgang = $("#jahrgang").val().trim();
                let telefon = $("#telefon").val().trim();

                if (editRow) {
                    editRow.data([id, nachname, vorname, jahrgang, telefon, ""]).draw(false);
                } else {
                    table.row.add([id || idCounter++, nachname, vorname, jahrgang, telefon, ""]).draw(false);
                }
                closeModal();
            });

            $("#cancelEdit").on("click", closeModal);
            $("#editModal").on("click", function (e) {
                if (e.target === this) closeModal();
            });

            // ========= JSON Export / Import =========
            $("#downloadJSON").on("click", function () {
                let title = $("#groupTitle").val().trim();
                let dataArray = [];
                table.rows().every(function () {
                    let d = this.data();
                    dataArray.push({
                        id: parseInt(d[0]),
                        Nachname: d[1],
                        Vorname: d[2],
                        Jahrgang: d[3],
                        Telefon: d[4],
                    });
                });
                let json = JSON.stringify({ title: title, array: dataArray }, null, 4);
                let blob = new Blob([json], { type: "application/json" });
                let url = URL.createObjectURL(blob);
                let a = document.createElement("a");
                a.href = url;
                a.download = (title || "trainingsgruppe") + ".json";
                a.click();
                URL.revokeObjectURL(url);
            });

            $("#uploadJSON").on("change", function (event) {
                let file = event.target.files[0];
                if (!file) return;

                let reader = new FileReader();
                reader.onload = function (e) {
                    let content = JSON.parse(e.target.result);
                    $("#groupTitle").val(content.title || "");
                    table.clear();
                    content.array.forEach((item) => {
                        table.row.add([item.id, item.Nachname, item.Vorname, item.Jahrgang, item.Telefon, ""]);
                    });
                    table.draw();
                    idCounter = content.array.length
                        ? Math.max(...content.array.map((i) => i.id)) + 1
                        : 1;
                };
                reader.readAsText(file);
            });

            // ========= DRUCKFUNKTION =========
            $("#controls").append(`
  <button id="printList"><span class="material-icons">print</span>Drucken</button>
`);

            $("#printList").on("click", function () {
                let popup = $(`
    <div class="modal" id="printModal" style="display:flex;">
      <div class="modal-content" style="max-width:500px;">
        <h2>Druckoptionen</h2>
        <label>Art der Liste:</label>
        <select id="printType">
          <option value="training">üèä Schwimmtraining</option>
          <option value="unterricht">üßí Schwimmunterricht</option>
        </select><br>

        <label>Zeitraum w√§hlen:</label>
        <select id="dateMode">
          <option value="wochentage">Bestimmte Wochentage eines Monats</option>
          <option value="manuell">Manuelle Tagesauswahl</option>
        </select>

        <div id="weekdaySelect" style="margin-top:10px;">
          <label>Montag<input type="checkbox" value="Mo"></label>
          <label>Dienstag<input type="checkbox" value="Di"></label>
          <label>Mittwoch<input type="checkbox" value="Mi"></label>
          <label>Donnerstag<input type="checkbox" value="Do"></label>
          <label>Freitag<input type="checkbox" value="Fr"></label>
          <label>Samstag<input type="checkbox" value="Sa"></label>
          <label>Sonntag<input type="checkbox" value="So"></label>
          <br>
          <br><label>Monat: <input type="month" id="monthSelect"></label>
        </div>

        <div id="manualDates" style="margin-top:10px; display:none;">
          <div id="datePickers"></div>
          <button id="addDate" type="button" style="margin-top:8px; background-color: var(--accent); border:none; border-radius:4px; padding:5px 10px; cursor:pointer;">
            <span class="material-icons" style="font-size:18px; vertical-align:middle;">add</span> Datum hinzuf√ºgen
          </button>
        </div>

        <div class="modal-buttons" style="margin-top:20px;">
          <button id="cancelPrint">Abbrechen</button>
          <button id="confirmPrint">Drucken</button>
        </div>
      </div>
    </div>
  `);

                $("body").append(popup);

                function addDatePicker() {
                    const picker = $(`
      <div class="date-entry" style="margin-top:6px; display:flex; align-items:center; gap:6px;">
        <input type="date" class="manualDate" required>
        <button type="button" class="removeDate" title="Entfernen" style="background:none; border:none; cursor:pointer; color:#c00;">
          <span class="material-icons" style="font-size:20px;">delete</span>
        </button>
      </div>
    `);
                    picker.find(".removeDate").on("click", function () {
                        picker.remove();
                    });
                    $("#datePickers").append(picker);
                }

                $("#addDate").on("click", addDatePicker);

                $("#dateMode").on("change", function () {
                    if ($(this).val() === "wochentage") {
                        $("#weekdaySelect").show();
                        $("#manualDates").hide();
                    } else {
                        $("#weekdaySelect").hide();
                        $("#manualDates").show();
                        if ($("#datePickers .date-entry").length === 0) addDatePicker();
                    }
                });

                $("#cancelPrint").on("click", () => $("#printModal").remove());

                $("#confirmPrint").on("click", function () {
                    let type = $("#printType").val();
                    let days = [];

                    if ($("#dateMode").val() === "wochentage") {
                        let month = $("#monthSelect").val();
                        if (!month) return alert("Bitte Monat w√§hlen.");
                        let [year, mon] = month.split("-");
                        let selected = $("#weekdaySelect input:checked").map((_, c) => $(c).val()).get();
                        if (selected.length === 0) return alert("Bitte mindestens einen Wochentag w√§hlen.");

                        let weekdayMap = { So: 0, Mo: 1, Di: 2, Mi: 3, Do: 4, Fr: 5, Sa: 6 };
                        let daysInMonth = new Date(year, mon, 0).getDate();

                        for (let d = 1; d <= daysInMonth; d++) {
                            let date = new Date(year, mon - 1, d);
                            let wd = Object.keys(weekdayMap).find(k => weekdayMap[k] === date.getDay());
                            year = year.slice(-2);
                            if (selected.includes(wd)) {
                                days.push(`${String(d).padStart(2, "0")}.${String(mon).padStart(2, "0")}.${year}`);
                            }
                        }

                    } else {
                        $(".manualDate").each(function () {
                            const val = $(this).val();
                            if (val) {
                                const [y, m, d] = val.split("-");
                                let year = y.slice(-2);
                                days.push(`${d}.${m}.${year}`);
                            }
                        });
                        if (days.length === 0) return alert("Bitte mindestens ein Datum ausw√§hlen.");
                    }

                    $("#printModal").remove();

                    // Teilnehmer und Titel + Logo holen
                    let participants = table.rows().data().toArray().map(r => ({
                        Nachname: r[1],
                        Vorname: r[2],
                        Jahrgang: r[3],
                        Telefon: r[4]
                    }));
                    let groupTitle = $("#groupTitle").val().trim() || "Trainingsgruppe";
                    let logoSrc = $("header img").attr("src");

                    // Druckseite generieren
                    let html = `
      <html>
      <head>
        <title>Druckansicht</title>
        <style>
          body { font-family: 'Segoe UI', sans-serif; }
          header { display:flex; align-items:center; justify-content:center; gap:10px; }
          header img { height:60px; }
          header div { text-align:center; }
          h1 { margin:0; font-size:1.6rem; }
          h2 { margin:4px 0 0; font-size:1.1rem; color:#666; }
          table { width:100%; border-collapse:collapse; margin-top:20px; }
          th, td { border:1px solid #ccc; text-align:center; font-size:13px; }
          th { background:#ffeb3b; word-break: break-all; }
          input[type=checkbox]{width:16px;height:16px;}
          @media print {
            button { display:none; }
          }
        </style>
      </head>
      <body>
        <header>
          <img src="${logoSrc}" alt="Logo">
          <div>
            <h1>${groupTitle}</h1>
          </div>
        </header>

        <table>
          <thead>
            <tr>
              ${days.map(d => `<th>${d}</th>`).join("")}
              <th>Nachname</th>
              <th>Vorname</th>
              <th>Jahrgang</th>
              <th>Telefon</th>
              ${type === "unterricht"
                            ? "<th>Seepferdchen</th><th>Neuer Kurs</th><th>F√∂rderkurs</th>"
                            : ""}
            </tr>
          </thead>
          <tbody>
            ${participants.map(p => `
              <tr>
                ${days.map(() => `<td><input type="checkbox"></td>`).join("")}
                <td>${p.Nachname}</td>
                <td>${p.Vorname}</td>
                <td>${p.Jahrgang}</td>
                <td>${p.Telefon}</td>
                ${type === "unterricht"
                                    ? "<td><input type='checkbox'></td><td><input type='checkbox'></td><td><input type='checkbox'></td>"
                                    : ""
                                }
              </tr>`).join("")}
          </tbody>
        </table>

        <script>window.print();<\/script>
      </body>
      </html>
    `;
                    let printWin = window.open("", "_blank");
                    printWin.document.write(html);
                    printWin.document.close();
                });
            });


        });
    </script>

</body>

</html>